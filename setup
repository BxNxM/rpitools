#!/bin/bash

MYPATH="${BASH_SOURCE[0]}"
MYDIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
export REPOROOT="$MYDIR"
export OS=$(uname -o)
alias clean_cache="rm -f ${REPOROOT}/cache/.*_installed && rm -f ${REPOROOT}/cache/rpitools.log"


#source colors
source prepare_sd/colors.bash

# message handler function
function message() {
    local rpitools_log_path="${REPOROOT}/cache/rpitools.log"

    local msg="$1"
    if [ ! -z "$msg" ]
    then
        echo -e "$(date '+%Y.%m.%d %H:%M:%S') ${YELLOW}[ rpitools ]${NC} $msg"
        echo -e "$(date '+%Y.%m.%d %H:%M:%S') ${YELLOW}[ rpitools ]${NC} $msg" >> "$rpitools_log_path"
    fi
}

# exit if we are not on raspberyy pi
if [ "$OS" != "GNU/Linux" ]
 then
    message "This script work on raspbian, this OS $OS is not supported!"
    sleep 4
    exit 1
fi

# set DISPLAY=:0 if xinit is run
xinitrx_is_run=$(ps aux | grep "[x]initrc")
if [ "$xinitrx_is_run" != "" ]
then
    # set display environment (for PIXEL startx)
    message "Set DISPLAY env - gui is run"
    export DISPLAY=:0
fi

# restore existing backup
output=$(pushd "${REPOROOT}/tools/"; ./cache_restore_backup.bash restore; popd)
echo -e "$output"

# set vimrc
if [ -f ~/.vimrc ]
then
    message "~/.vimrc is already set"
else
    cp ${MYDIR}/template/vimrc ~/.vimrc
    message "cp ${MYDIR}/template/vimrc ~/.vimrc ...DONE"
fi

# source custom aliases
if [ -z $RPITOOLS_ALIASES ]
then
    source ${MYDIR}/template/aliases
    message "${MYDIR}/template/aliases source ...DONE"
    export RPITOOLS_ALIASES="true"
else
    message "${MYDIR}/template/aliases is already sourced"
fi

if [ -e ~/.bash_aliases ]
then
    message "~/.bash_aliases is already exists."
else
    message "Create ~/.bash_aliases with ${MYDIR}/template/aliases"
    echo -e "source ${MYDIR}/template/aliases" > ~/.bash_aliases
fi

# set ssh folder
if [ ! -d ~/.ssh ]
then
    message "Create ~/.ssh folder and ~/.ssh/authorized_keys file"
    mkdir ~/.ssh
    echo "" > ~/.ssh/authorized_keys
    message "Set your public key (id_pub.rsa) for pwdless ssh in ~/.ssh/authorized_keys"
else
    if [ -e ~/.ssh/authorized_keys ]
    then
        is_set=$(cat ~/.ssh/authorized_keys)
        if [ "$is_set" == "" ]
        then
           message "Set your public key (id_pub.rsa) for pwdless ssh in ~/.ssh/authorized_keys"
        else
           message "~/.ssh/authorized_keys is already set"
        fi
    else
        message "Create ~/.ssh/authorized_keys file."
        echo "" > ~/.ssh/authorized_keys
        message "Set your public key (id_pub.rsa) for pwdless ssh in ~/.ssh/authorized_keys"
    fi
fi

# config files list
file_to_link_list=("/etc/wpa_supplicant/wpa_supplicant.conf" \
                   "/lib/systemd/system/" \
                   "/boot/config.txt" \
                   "/var/log" \
                   "/etc/fstab" \
                   "/etc/transmission-daemon/settings.json" \
                   "/etc/logrotate.conf")
# linking config files and used folders under config folder
for file_path in "${file_to_link_list[@]}"
do
    filename=$(basename "$file_path")
    extension="${filename##*.}"
    filename="${filename%.*}"

    # make directory extension correction
    if [ -d "$file_path" ] || [ "$filename" == "fstab" ]
    then
        extension=""
    else
        extension=".$extension"
    fi

    # make links if not exists
    if [  -e "$REPOROOT/config/${filename}${extension}" ]
    then
        message "$REPOROOT/config/${filename}${extension} is already linked"
    else
        message "Linking: ln -s ${file_path} $REPOROOT/config/${filename}${extension}"
        ln -s "${file_path}" "$REPOROOT/config/${filename}${extension}"
    fi
done

# update once (first run ever) before install apps
is_installed_file_indicator="$REPOROOT/cache/.first_boot_update_update_installed"
if [ -e "$is_installed_file_indicator" ]
then
    message "After first boot update already done"
else
    message "Make updates after first boot."
    . ${MYDIR}/install_updates.bash
    if [ "$?" -eq 0 ]
    then
       echo "$(date) First boot update done" > "$is_installed_file_indicator"
    else
        message "ERROR: ${MYDIR}/install_updates.bash"
    fi
fi

# Adafruit repo - install oled library
if [ ! -e "${REPOROOT}/gpio/Adafruit_Python_SSD1306" ]
then
    message "Install Adafruit_Python_SSD1306"
    pushd gpio

    message "Clone git repository: git clone https://github.com/adafruit/Adafruit_Python_SSD1306.git"
    git clone https://github.com/adafruit/Adafruit_Python_SSD1306.git
    if [ "$?" != 0 ]
    then
        message "git clone - failed"
    else
        message "Installation: cd Adafruit_Python_SSD1306 && sudo python setup.py install"
        cd Adafruit_Python_SSD1306
        sudo python setup.py install
        if [ "$?" != 0 ]
        then
            message "sudo python setup.py install - failed"
        fi
        cd -
    fi

    popd
else
    message "Adafruit_Python_SSD1306 already installed"
fi

# set welcome comsole settings
welcome_screen_settings_output=$(${REPOROOT}/tools/welcome_config/set_welcome_screen.bash)
message "$welcome_screen_settings_output"

# install tools apps
message "Install requested programs from list ${MYDIR}/template/programs.dat:"
. ${MYDIR}/install_apps.bash

# backup modification configs
output=$(pushd "${REPOROOT}/tools/"; ./cache_restore_backup.bash backup; popd)
echo -e "$output"

